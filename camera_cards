#!/usr/bin/env bash

# a script to turn raw camera cards into SIPs

# load nmaahcmmfunctions into this script
SCRIPT_PATH="${0%/*}"
. "${SCRIPT_PATH}/nmaahcmmfunctions"
[[ -f "${SCRIPT_PATH}/nmaahcmmfunctions" ]] || { echo "Missing '${SCRIPT_PATH}/nmaahcmmfunctions'. Exiting." ; exit 1 ;};
_initialize_make # safe script termination process defined in nmaahcmmfunctions
DEPENDENCIES=(ffmpeg)
OP="${USER}"

## USAGE

_usage(){
    echo
    echo "$(basename "${0}")"
    echo "This script will detect a Canon C100 or C300 camera card structure and transform the original camera card directory structure into a usable AIP. The script will concatenate video files into a single file, make a new directory structure, and create a log of these changes."
    echo "Your output package will be delivered to the AIP destination set in nmaahcmmconfig, which is currently ${AIP_DESTINATION}"
    echo "Dependencies: ${DEPENDENCIES[@]}"
    echo "Usage: $(basename ${0}) -m MEDIAID"
    echo "  -m MEDIAID (type media id for final package, e.g. SC0001_20190101_SMITH_VHS_01)"
    echo "  -h display this help"
    echo
    exit
}
# getopts loop
OPTIND=1
while getopts ":m:o:h" OPT; do
    case "${OPT}" in
        m) MEDIAID="${OPTARG}" ;;
        h) _usage ;;  # if the operator runs "[scriptname] -h" then the _usage text above will display in the terminal
        *) echo "Invalid option -${OPTARG}" ; _usage ;; # if the operator tries to use an option other than the ones listed above, the _usage text will display in the terminal
    esac
done
shift $(( ${OPTIND} - 1 ))

CAMERA_CARD_DIR="${1}"

# ask for camera card if it wasn't supplied
if [[ -z "${CAMERA_CARD_DIR}" ]] ; then
    _report -b "Drag in the input directory or type 'q' to quit: "
    read -e CAMERA_CARD_DIR
    [[ "${CAMERA_CARD_DIR}" = "q" ]] && exit 0
fi
# check that camera card is a directory
if [[ ! -d "${CAMERA_CARD_DIR}" ]] ; then
    _report -rt "ERROR: Input directory ${CAMERA_CARD_DIR} is not a directory. Exiting..."
    _log -a "Process terminated by script (input was not a directory)."
    exit 1
fi
# ask for MEDIAID if it wasn't supplied
if [[ -z "${MEDIAID}" ]] ; then
    _report -b "Enter a unique package name or 'q' to quit: "
    read -e MEDIAID
    [[ "${MEDIAID}" = "q" ]] && exit 0
fi

## SCRIPT ACTIONS

# log script beginning
_log -b

# detect camera card structure based on directory name
if [[ -n "$(find "${CAMERA_CARD_DIR}" -type d -iname "STREAM")" ]] ; then
    echo "Camera card type identified: Canon C100"
    CAMERA_CARD_TYPE="C100"
elif [[ -n "$(find "${CAMERA_CARD_DIR}" -type d -iname "CLIPS001")" ]] ; then
    echo "Camera card type identified: Canon C300"
    CAMERA_CARD_TYPE="C300"
else
    _report -b "Camera card type not identified. Applying generic package structure..."
    CAMERA_CARD_TYPE="GENERAL"
fi

# create temp files and directory structure
AIPDIR="${AIP_DESTINATION}/${MEDIAID}"
mkdir -p "${AIPDIR}/objects" "${AIPDIR}/nmaahc_metadata" "${AIPDIR}/camera_metadata"
TEMP_ALLFILES="${AIPDIR}/temp_allfiles.txt"
TEMP_VIDEOLIST="${AIPDIR}/temp_videolist.txt"
TEMP_AUDIOLIST="${AIPDIR}/temp_audiolist.txt"
TEMP_CONCATLIST="${AIPDIR}/temp_concatlist.txt"
TEMP_METADATALIST="${AIPDIR}/temp_metadatalist.txt"

_writelog "OPERATOR" "${OP}"
_writelog "CAMERA CARD DIRECTORY" "${CAMERA_CARD_DIR}"
_writelog "CAMERA CARD TYPE" "${CAMERA_CARD_TYPE}"
_writelog "MEDIAID" "${MEDIAID}"
_writelog "AIPDIR" "${AIPDIR}"

# create reports of the original files
# tree
TREE="${AIPDIR}/nmaahc_metadata/${MEDIAID}_$(basename "${CAMERA_CARD_DIR}")_tree.txt"
tree -DaNs --du --timefmt "%Y-%m-%dT%H:%M:%SZ" "${CAMERA_CARD_DIR}" > "${TREE}"
# mediainfo, exiftool, ffprobe
if [[ "${CAMERA_CARD_TYPE}" == "C100" ]] ; then
    find "${CAMERA_CARD_DIR}" -iname "*.mts" | sort -z > "${TEMP_VIDEOLIST}"
elif [[ "${CAMERA_CARD_TYPE}" == "C300" ]] ; then
    find "${CAMERA_CARD_DIR}" -iname "*.mxf" | sort -z > "${TEMP_VIDEOLIST}"
elif [[ "${CAMERA_CARD_TYPE}" == "GENERAL" ]] ; then
    find "${CAMERA_CARD_DIR}" -type f > "${TEMP_ALLFILES}"
    # identify all video and audio files; sort video and audio files into separate lists, and all other files into a list of metadata files
    while read FILE ; do
        if [[ -n $(mediainfo --Inform="General;%VideoCount%" "${FILE}") ]] ; then
            echo "${FILE}" >> "${TEMP_VIDEOLIST}"
        elif [[ -n $(mediainfo --Inform="General;%AudioCount%" "${FILE}") ]] ; then
            echo "${FILE}" >> "${TEMP_AUDIOLIST}"
        elif [[ -f "${FILE}" ]] ; then
            echo "${FILE}" >> "${TEMP_METADATALIST}"
        fi
    done <"${TEMP_ALLFILES}"
    sort -o "${TEMP_VIDEOLIST}" "${TEMP_VIDEOLIST}"
fi
while read FILE ; do
    MEDIAINFO_OUTPUT="${AIPDIR}/nmaahc_metadata/$(basename ${FILE})_mediainfo.txt"
    EXIFTOOL_OUTPUT="${AIPDIR}/nmaahc_metadata/$(basename ${FILE})_exiftool.txt"
    FFPROBE_OUTPUT="${AIPDIR}/nmaahc_metadata/$(basename ${FILE})_ffprobe.xml"
    mediaconch -mi -ft "${FILE}" >> "${MEDIAINFO_OUTPUT}"
    exiftool "${FILE}" >> "${EXIFTOOL_OUTPUT}"
    ffprobe 2> /dev/null "${FILE}" -show_format -show_streams -show_data -show_error -show_versions -show_chapters -noprivate -of xml="q=1:x=1" > "${FFPROBE_OUTPUT}"
done <"${TEMP_VIDEOLIST}"

# concatenate video files into a single file
if [[ "${CAMERA_CARD_TYPE}" == "C100" ]] ; then
    FIRST_FILE="$(head -n 1 "${TEMP_VIDEOLIST}")"
    while read FILE ; do
        echo "file '${FILE}'" >> "${TEMP_CONCATLIST}"
    done <"${TEMP_VIDEOLIST}"
    # concatenate video files in the order they are printed in $TEMP_CONCATLIST; map metadata from the first video file (in sequence) onto the final concatenated file
    ffmpeg -f concat -safe 0 -i "${TEMP_CONCATLIST}" -i "${FIRST_FILE}" -map 0 -map_metadata 1 -c copy "${AIPDIR}/objects/${MEDIAID}_concatenated.mts"
    _writelog "CONCATENATED VIDEO FILE" "${AIPDIR}/objects/${MEDIAID}_concatenated.mts"
elif [[ "${CAMERA_CARD_TYPE}" == "C300" ]] ; then
    FIRST_FILE="$(head -n 1 "${TEMP_VIDEOLIST}")"
    while read FILE ; do
        echo "file '${FILE}'" >> "${TEMP_CONCATLIST}"
    done <"${TEMP_VIDEOLIST}"
    # concatenate all the files in order, as they are printed in $TEMP_CONCATLIST; map the metadata from the first video file (in sequence) onto the concatenated file
    ffmpeg -f concat -safe 0 -i "${TEMP_CONCATLIST}" -i "${FIRST_FILE}" -map 0 -map_metadata 1 -c copy "${AIPDIR}/objects/${MEDIAID}_concatenated.mxf"
    _writelog "CONCATENATED VIDEO FILE" "${AIPDIR}/objects/${MEDIAID}_concatenated.mxf"
elif [[ "${CAMERA_CARD_TYPE}" == "GENERAL" ]] ; then
    FIRST_FILE="$(head -n 1 "${TEMP_VIDEOLIST}")"
    while read FILE ; do
        echo "file '${FILE}'" >> "${TEMP_CONCATLIST}"
        # general profile only: move all video files to AIP as separate files, in case concatenation does not work for this camera card structure
        rsync -avh --progress "${FILE}" "${AIPDIR}/objects/"
    done <"${TEMP_VIDEOLIST}"
    # concatenate all the files in order, as they are printed in $TEMP_CONCATLIST; map the metadata from the first video file (in sequence) onto the concatenated file
    FIRST_FILE_BASENAME=$(basename "${FIRST_FILE}")
    FIRST_FILE_EXTENSION="${FIRST_FILE_BASENAME##*.}"
    ffmpeg -f concat -safe 0 -i "${TEMP_CONCATLIST}" -i "${FIRST_FILE}" -map 0 -map_metadata 1 -c copy "${AIPDIR}/objects/${MEDIAID}_concatenated.${FIRST_FILE_EXTENSION}"
    _writelog "CONCATENATED VIDEO FILE" "${AIPDIR}/objects/${MEDIAID}_concatenated.${FIRST_FILE_EXTENSION}"
    # general profile only: move all audio files to AIP as separate files
    while read FILE ; do 
        rsync -avh --progress "${FILE}" "${AIPDIR}/objects/"
    done <"${TEMP_AUDIOLIST}"
fi

# move significant camera-generated metadata files to a metadata folder
if [[ "${CAMERA_CARD_TYPE}" == "C100" ]] ; then
    find "${CAMERA_CARD_DIR}" -iname "*.cpi" >> "${TEMP_METADATALIST}"
    while read FILE ; do
        rsync -avh "${FILE}" "${AIPDIR}/camera_metadata/$(basename ${FILE})"
    done <"${TEMP_METADATALIST}"
elif [[ "${CAMERA_CARD_TYPE}" == "C300" ]] ; then
    find "${CAMERA_CARD_DIR}" -iname "*.xml" >> "${TEMP_METADATALIST}"
    while read FILE ; do
        rsync -avh "${FILE}" "${AIPDIR}/camera_metadata/$(basename ${FILE})"
    done <"${TEMP_METADATALIST}"
elif [[ "${CAMERA_CARD_TYPE}" == "GENERAL" ]] ; then
    while read FILE ; do
        rsync -avh "${FILE}" "${AIPDIR}/camera_metadata/$(basename ${FILE})"
    done <"${TEMP_METADATALIST}"
fi

# remove .DS_Store files and log action if successful
"${SCRIPTDIR}/removeDSStore" "${AIPDIR}" && _writelog ".DS_Store files removed by invoking removeDSStore" "$(date +%FT%T)"

# log script ending
rm "${TEMP_ALLFILES}" "${TEMP_VIDEOLIST}" ${TEMP_AUDIOLIST} "${TEMP_CONCATLIST}" "${TEMP_METADATALIST}"
_log -e
_report -g "camera_cards process complete. Your AIP can be found at ${AIPDIR}. A log file can be found at ${LOGDIR%/}/${LOGNAME}"

echo
